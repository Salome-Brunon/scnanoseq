/*
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Config file for defining DSL2 per module options and publishing paths
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    Available keys to override module options:
        ext.args   = Additional arguments appended to command in module.
        ext.args2  = Second set of arguments appended to command in module (multi-tool modules).
        ext.args3  = Third set of arguments appended to command in module (multi-tool modules).
        ext.prefix = File name prefix for output files.
----------------------------------------------------------------------------------------
*/

process {

    publishDir = [
        path: { "${params.outdir}/${task.process.tokenize(':')[-1].tokenize('_')[0].toLowerCase()}" },
        mode: params.publish_dir_mode,
        saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
    ]

    withName: SAMPLESHEET_CHECK {
        publishDir = [
            path: { "${params.outdir}/pipeline_info" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }

    withName: CUSTOM_DUMPSOFTWAREVERSIONS {
        publishDir = [
            path: { "${params.outdir}/pipeline_info" },
            mode: params.publish_dir_mode,
            pattern: '*_versions.yml'
        ]
    }

}

//////////////
// FASTQ QC //
//////////////

// FASTQC
if (!params.skip_qc && !params.skip_fastqc) {
    process {
        withName: '.*:FASTQC_NANOPLOT_PRE_TRIM:FASTQC' {
            ext.prefix = { "${meta.id}_raw" }
            publishDir = [
                path: { "${params.outdir}/fastqc/pre_trim" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
        }

        withName: '.*:FASTQC_NANOPLOT_POST_TRIM:FASTQC' {
            ext.prefix = { "${meta.id}_filtered" }
            publishDir = [
                path: { "${params.outdir}/fastqc/post_trim" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
        }

        withName: '.*:FASTQC_NANOPLOT_POST_EXTRACT:FASTQC' {
            ext.prefix = { "${meta.id}.umi_extract"}
            publishDir = [
                path: { "${params.outdir}/fastqc/post_extract" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
        }

    }
}

// NANOPLOT
if (!params.skip_qc && !params.skip_nanoplot) {
    process {
        withName: '.*:FASTQC_NANOPLOT_PRE_TRIM:NANOPLOT' {
            publishDir = [
                path: { "${params.outdir}/nanoplot/pre_trim/${meta.id}" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
        }

        withName: '.*:FASTQC_NANOPLOT_POST_TRIM:NANOPLOT' {
            publishDir = [
                path: { "${params.outdir}/nanoplot/post_trim/${meta.id}" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
        }

        withName: '.*:FASTQC_NANOPLOT_POST_EXTRACT:NANOPLOT' {
            publishDir = [
                path: { "${params.outdir}/nanoplot/post_extract/${meta.id}" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
        }

    }
}

// NANOCOMP
if (!params.skip_qc && !params.skip_fastq_nanocomp) {
    process {
        withName: '.*:NANOCOMP_FASTQ' {
            publishDir = [
                path: { "${params.outdir}/nanocomp/fastq" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
                ]
        }
    }
}

if (!params.skip_qc && !params.skip_bam_nanocomp) {
    process {
        withName: '.*:NANOCOMP_BAM' {
            publishDir = [
                path: { "${params.outdir}/nanocomp/bam" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
                ]
        }
    }
}

// SAMTOOLS
if (!params.skip_qc){
    process {
        withName:'.*:BAM_SORT_STATS_SAMTOOLS_MINIMAP:BAM_STATS_SAMTOOLS:.*' {
            ext.prefix = { "${meta.id}.minimap" }
            publishDir = [
                path: { "${params.outdir}/qc/samtools/minimap" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
            ]
        }
    }
    
    process {
        withName:'.*:BAM_SORT_STATS_SAMTOOLS_FILTERED:BAM_STATS_SAMTOOLS:.*' {
            ext.prefix = { "${meta.id}.mapped_only" }
            publishDir = [
                path: { "${params.outdir}/qc/samtools/mapped_only" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
            ]
        }
    }
    
    process {
        withName:'.*:BAM_SORT_STATS_SAMTOOLS_CORRECTED:BAM_STATS_SAMTOOLS:.*' {
            ext.prefix = { "${meta.id}.corrected" }
            publishDir = [
                path: { "${params.outdir}/qc/samtools/corrected" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
            ]
        }
    }
    
    process {
        withName:'.*:BAM_SORT_STATS_SAMTOOLS_DEDUP:BAM_STATS_SAMTOOLS:.*' {
            ext.prefix = { "${meta.id}.dedup" }
            publishDir = [
                path: { "${params.outdir}/qc/samtools/dedup" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
            ]
        }
    }
}

////////////////////
// FASTQ TRIMMING //
////////////////////

if (!params.skip_trimming) {
    if ( params.trimming_software == 'nanofilt' ){
        process {
            withName:'.*:NANOFILT' {
                publishDir = [
                    enabled: false
                ]
            }
        }

        process {
            withName: '.*:ZIP_TRIM' {
                publishDir = [
                    path: { "${params.outdir}/fastq/trimmed_nanofilt" },
                    mode: params.publish_dir_mode,
                    saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
                ]
            }
        }
    } else if (params.trimming_software == 'prowler') {

        process {
            withName:'.*:PROWLERTRIMMER' {
                publishDir = [
                    enabled: false
                ]
            }
        }

        process {
            withName: '.*:ZIP_TRIM' {
                publishDir = [
                    path: { "${params.outdir}/fastq/trimmed_prowlertrimmer" },
                    mode: params.publish_dir_mode,
                    saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
                ]
            }
        }
    }
}

///////////
// BLAZE //
///////////

process {
    withName: '.*:BLAZE' {
        cpus = 10
        publishDir = [
            path: { "${params.outdir}/blaze" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
}

///////////////////////
// CREATE_REGEX_INFO //
///////////////////////

process {
    withName: '.*:CREATE_REGEX_INFO:CREATE_REGEX' {
        publishDir = [
            path: { "${params.outdir}/references/regex_info" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
}

//////////////////////////////
// INTRON RETENTION METHODS //
//////////////////////////////

if (params.intron_retention_method == "1"){

    ////////////////////////
    // TRANSCRIPT_TO_EXON //
    ////////////////////////

    process {
        withName: '.*:TRANSCRIPT_TO_EXON' {
            publishDir = [
                path: { "${params.outdir}/references/gtf/" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
            ]
        }
    }
} else if (params.intron_retention_method == "2"){

    ///////////////////
    // SORT_BEDTOOLS //
    ///////////////////

    process {
        withName: '.*:SORT_BEDTOOLS' {
            publishDir = [
                enabled: false
            ]
        }
    }

    ///////////////////////
    // CREATE_INTRON_GTF //
    ///////////////////////

    process {
        withName: '.*:CREATE_INTRON_GTF' {
            publishDir = [
                enabled: false
            ]
        }
    }

    //////////////////////
    // GET_GTF_FEATURES //
    //////////////////////

    process {
        withName: '.*:GET_GTF_FEATURES' {
            publishDir = [
                enabled: false
            ]
        }
    }

    /////////////
    // GTF2BED //
    /////////////

    process {
        withName: '.*:GTF2BED' {
            publishDir = [
                enabled: false
            ]
        }
    }

    ////////////////////////
    // UCSC_BEDTOGENEPRED //
    ////////////////////////

    process {
        withName: '.*:UCSC_BEDTOGENEPRED' {
            publishDir = [
                enabled: false
            ]
        }
    }

    ////////////////////////
    // UCSC_GENEPREDTOGTF //
    ////////////////////////

    process {
        withName: '.*:UCSC_GENEPREDTOGTF' {
            publishDir = [
                enabled: false
            ]
        }
    }

    //////////////////////////
    // CUSTOM_GETCHROMSIZES //
    //////////////////////////

    process {
        withName: '.*:CUSTOM_GETCHROMSIZES' {
            publishDir = [
                enabled: false
            ]
        }
    }

    ////////////////////
    // COMPLEMENT_GTF //
    ////////////////////

    process {
        withName: '.*:COMPLEMENT_GTF' {
            publishDir = [
                enabled: false
            ]
        }
    }

    //////////////////////////
    // COMPLEMENT_NONINTRON //
    //////////////////////////

    process {
        withName: '.*:COMPLEMENT_NONINTRON' {
            publishDir = [
                enabled: false
            ]
        }
    }

    /////////////
    // CAT_BED //
    /////////////

    process {
        withName: '.*:CAT_BED' {
            publishDir = [
                enabled: false
            ]
        }
    }

    /////////////
    // CAT_GTF //
    /////////////
    process {
        withName: '.*:CAT_GTF' {
            publishDir = [
                path: { "${params.outdir}/references/gtf/" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
            ]
        }
    }
}

////////////
// GUNZIP //
////////////

process {
    withName: '.*:GUNZIP' {
        publishDir = [
            enabled: false
        ]
    }
}

////////////////
// SPLIT_FILE //
////////////////

process {
    withName: '.*:SPLIT_FILE' {
        publishDir = [
            enabled: false
        ]
    }
}

//////////
// PIGZ //
//////////

process {
    withName: '.*:ZIP_R1' {
        publishDir = [
            path: { "${params.outdir}/fastq/pre_extract/${meta.id}" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
}

process {
    withName: '.*:ZIP_R2' {
        publishDir = [
            path: { "${params.outdir}/fastq/pre_extract/${meta.id}" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
}

//////////////////////
// PREEXTRACT_FASTQ //
//////////////////////

process {
    withName: '.*:PREEXTRACT_FASTQ' {
        publishDir = [
            enabled: false
        ]
    }
}

/////////////
// MINIMAP //
/////////////

// TODO: "reverse" may not be the best description of ub...;
// maybe just go by directRNA/cDNA protocol choice or both
if (!params.skip_save_minimap2_index) {
    process {
        withName:'.*:MINIMAP2_INDEX' {
            ext.args = {
                [
                    "-ax splice",
                    params.stranded == "forward" ? "-uf" : params.stranded == "reverse" ? "-ub" : "-un",
                    "-k${params.kmer_size}",
                    params.save_secondary_alignment == false ? "--secondary=no " : "--secondary=yes "
                ].join(' ').trim()
            }
        }
    }
}

process {
    withName:'.*:MINIMAP2_ALIGN' {
        ext.args = {
            [
                "--MD -ax splice",
                params.stranded == "forward" ? "-uf" : params.stranded == "reverse" ? "-ub" : "-un",
                "-k${params.kmer_size}",
                params.save_secondary_alignment == false ? "--secondary=no " : "--secondary=yes "
            ].join(' ').trim()
        }
    }
}

////////////////
// SAM to BAM //
////////////////

// TODO: make output tmp ; again for now keeping it on for tests
process {
    withName:'.*:SAMTOOLS_VIEW_BAM' {
        ext.args = "-h --output-fmt bam"
        publishDir = [
            path: { "${params.outdir}/minimap2/original" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
}

/////////////////////////
// FILTER MAPPED READS //
/////////////////////////

process {
    withName:'.*:SAMTOOLS_VIEW_FILTER' {
        ext.args = "-b -F 4"
        ext.prefix = { "${meta.id}.mapped_only" }
        publishDir = [
            path: { "${params.outdir}/minimap2/filtered" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
}

////////////////
// SORT READS //
////////////////

process {
    withName:'.*:BAM_SORT_STATS_SAMTOOLS_MINIMAP:SAMTOOLS_SORT' {
        ext.prefix = { "${meta.id}.sorted" }
        publishDir = [
            path: { "${params.outdir}/minimap2/sorted" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
}

process {
    withName:'.*:BAM_SORT_STATS_SAMTOOLS_FILTERED:SAMTOOLS_SORT' {
        ext.prefix = { "${meta.id}.mapped_only.sorted" }
        publishDir = [
            path: { "${params.outdir}/minimap2/filtered" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
}

///////////
// INDEX //
///////////

process {
    withName:'.*:BAM_SORT_STATS_SAMTOOLS_MINIMAP:SAMTOOLS_INDEX' {
        publishDir = [
            path: { "${params.outdir}/minimap2/sorted" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
}

process {
    withName:'.*:BAM_SORT_STATS_SAMTOOLS_FILTERED:SAMTOOLS_INDEX' {
        publishDir = [
            path: { "${params.outdir}/minimap2/filtered" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
}

/////////////////
// TAG_BARCODE //
/////////////////

process {
    withName: '.*:TAG_BARCODES' {
        publishDir = [
            path: { "${params.outdir}/bam/tagged" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
}

//////////////////////
// CORRECT_BARCODES //
//////////////////////

process {
    withName: '.*:CORRECT_BARCODES' {
        publishDir = [
            path: { "${params.outdir}/bam/corrected" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
}

process {
    withName: '.*:SAMTOOLS_INDEX_BC_CORRECTED' {
        publishDir = [
            path: { "${params.outdir}/bam/corrected" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
}

////////////////////
// UMITOOLS_DEDUP //
////////////////////

process {
    withName: '.*:UMITOOLS_DEDUP' {
        ext.prefix = { "${meta.id}.dedup" }
        publishDir = [
            path: { "${params.outdir}/bam/dedup" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
}

process {
    withName: '.*:SAMTOOLS_INDEX_DEDUP' {
        ext.prefix = { "${meta.id}.dedup" }
        publishDir = [
            path: { "${params.outdir}/bam/dedup" },
            mode: params.publish_dir_mode,
            saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
        ]
    }
}

//////////////
// ISOQUANT //
//////////////

process {
    withName: '.*:ISOQUANT' {
        ext.args = {
            [
                "--complete_genedb",
                params.stranded == "forward" ? "--stranded forward" : params.stranded == "reverse" ? "--stranded reverse" : "--stranded none",
            ].join(' ').trim()
        }
    }
}

///////////////
// SEURAT_QC //
///////////////

if (!params.skip_qc && !params.skip_seurat) {
    process {
        withName: '.*:SEURAT_GENE' {
            publishDir = [
                path: { "${params.outdir}/seurat/gene" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
            ]
        }
    }

    process {
        withName: '.*:SEURAT_TRANSCRIPT' {
            publishDir = [
                path: { "${params.outdir}/seurat/transcript" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
            ]
        }
    }

    //***TODO***: don't forget filtered outputs [here or in main workflow, need to check]
    // so outputs will need to be changed
    process {
        withName: '.*:COMBINE_SEURAT_STATS_GENE' {
            ext.args = "-o gene.corrected.tsv -f gene"
            publishDir = [
                path: { "${params.outdir}/seurat/gene" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
            ]
        }
    }

    process {
        withName: '.*:COMBINE_SEURAT_STATS_TRANSCRIPT' {
            ext.args = "-o transcript.corrected.tsv -f transcript"
            publishDir = [
                path: { "${params.outdir}/seurat/transcript" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
            ]
        }
    }
}

/////////////
// MULTIQC //
/////////////

if (!params.skip_qc) {
    process {
        withName: '.*:MULTIQC_FINALQC' {
            publishDir = [
                path: { "${params.outdir}/multiqc/final_qc" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
            ]
        }
    }

    process {
        withName: '.*:MULTIQC_RAWQC' {
            publishDir = [
                path: { "${params.outdir}/multiqc/raw_qc" },
                mode: params.publish_dir_mode,
                saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
            ]
        }
    }
}
